diff a/src/output-json-http.c b/src/output-json-http.c	(rejected hunks)
@@ -178,23 +178,16 @@ struct {
     { "www_authenticate", "www-authenticate", 0 },
 };
 
-
-/* JSON format logging */
-static void JsonHttpLogJSON(JsonHttpLogThread *aft, json_t *js, htp_tx_t *tx)
+void JsonHttpLogJSONBasic(json_t *js, htp_tx_t *tx)
 {
-    LogHttpFileCtx *http_ctx = aft->httplog_ctx;
-    json_t *hjs = json_object();
-    if (hjs == NULL) {
-        return;
-    }
-
     char *c;
+
     /* hostname */
     if (tx->request_hostname != NULL)
     {
         c = bstr_util_strdup_to_c(tx->request_hostname);
         if (c != NULL) {
-            json_object_set_new(hjs, "hostname", json_string(c));
+            json_object_set_new(js, "hostname", json_string(c));
             SCFree(c);
         }
     }
@@ -292,63 +289,76 @@ static void JsonHttpLogJSON(JsonHttpLogThread *aft, json_t *js, htp_tx_t *tx)
             }
         }
     }
+}
 
-    if (http_ctx->flags & LOG_HTTP_EXTENDED) {
+void JsonHttpLogJSONExtended(json_t *js, htp_tx_t *tx)
+{
+    char *c;
 
-        /* referer */
-        htp_header_t *h_referer = NULL;
-        if (tx->request_headers != NULL) {
-            h_referer = htp_table_get_c(tx->request_headers, "referer");
+    /* referer */
+    htp_header_t *h_referer = NULL;
+    if (tx->request_headers != NULL) {
+        h_referer = htp_table_get_c(tx->request_headers, "referer");
+    }
+    if (h_referer != NULL) {
+        c = bstr_util_strdup_to_c(h_referer->value);
+        if (c != NULL) {
+            json_object_set_new(js, "http_refer", json_string(c));
+            SCFree(c);
         }
-        if (h_referer != NULL) {
-            c = bstr_util_strdup_to_c(h_referer->value);
-            if (c != NULL) {
-                json_object_set_new(hjs, "http_refer", json_string(c));
-                SCFree(c);
-            }
+    }
+
+    /* method */
+    if (tx->request_method != NULL) {
+        c = bstr_util_strdup_to_c(tx->request_method);
+        if (c != NULL) {
+            json_object_set_new(js, "http_method", json_string(c));
+            SCFree(c);
         }
+    }
 
-        /* method */
-        if (tx->request_method != NULL) {
-            c = bstr_util_strdup_to_c(tx->request_method);
-            if (c != NULL) {
-                json_object_set_new(hjs, "http_method", json_string(c));
-                SCFree(c);
-            }
+    /* protocol */
+    if (tx->request_protocol != NULL) {
+        c = bstr_util_strdup_to_c(tx->request_protocol);
+        if (c != NULL) {
+            json_object_set_new(js, "protocol", json_string(c));
+            SCFree(c);
         }
+    }
 
-        /* protocol */
-        if (tx->request_protocol != NULL) {
-            c = bstr_util_strdup_to_c(tx->request_protocol);
-            if (c != NULL) {
-                json_object_set_new(hjs, "protocol", json_string(c));
-                SCFree(c);
-            }
+    /* response status */
+    if (tx->response_status != NULL) {
+        c = bstr_util_strdup_to_c(tx->response_status);
+        if (c != NULL) {
+            json_object_set_new(js, "status", json_string(c));
+            SCFree(c);
         }
 
-        /* response status */
-        if (tx->response_status != NULL) {
-            c = bstr_util_strdup_to_c(tx->response_status);
+        htp_header_t *h_location = htp_table_get_c(tx->response_headers, "location");
+        if (h_location != NULL) {
+            c = bstr_util_strdup_to_c(h_location->value);
             if (c != NULL) {
-                json_object_set_new(hjs, "status", json_string(c));
+                json_object_set_new(js, "redirect", json_string(c));
                 SCFree(c);
             }
-
-            htp_header_t *h_location = htp_table_get_c(tx->response_headers, "location");
-            if (h_location != NULL) {
-                c = bstr_util_strdup_to_c(h_location->value);
-                if (c != NULL) {
-                    json_object_set_new(hjs, "redirect", json_string(c));
-                    SCFree(c);
-                }
-            }
         }
-
-        /* length */
-        json_object_set_new(hjs, "length", json_integer(tx->response_message_len));
     }
 
-    json_object_set_new(js, "http", hjs);
+    /* length */
+    json_object_set_new(js, "length", json_integer(tx->response_message_len));
+
+}
+
+/* JSON format logging */
+static void JsonHttpLogJSON(JsonHttpLogThread *aft, json_t *js, htp_tx_t *tx)
+{
+    LogHttpFileCtx *http_ctx = aft->httplog_ctx;
+    JsonHttpLogJSONBasic(js, tx);
+    /* log custom fields if configured */
+    if (http_ctx->fields != 0)
+        JsonHttpLogJSONCustom(http_ctx, js, tx);
+    if (http_ctx->flags & LOG_HTTP_EXTENDED)
+        JsonHttpLogJSONExtended(js, tx);
 }
 
 static int JsonHttpLogger(ThreadVars *tv, void *thread_data, const Packet *p, Flow *f, void *alstate, void *txptr, uint64_t tx_id)
